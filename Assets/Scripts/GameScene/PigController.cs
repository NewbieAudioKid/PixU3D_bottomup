// ================================================================================
// TL;DR:
// å°„æ‰‹çŒªçŒªæ ¸å¿ƒæ§åˆ¶å™¨ï¼Œæ•´åˆçŠ¶æ€ç®¡ç†ã€é¢„è®¡ç®—å°„å‡»ã€ä¼ é€å¸¦å·¡é€»å’Œç»åœ°åå‡»æœºåˆ¶ã€‚
// é‡‡ç”¨åç¨‹é©±åŠ¨çš„äº‹ä»¶æµæ¶æ„ï¼Œæ”¯æŒå¤æ‚æ—¶åºæ§åˆ¶å’ŒåŠ¨ç”»ç¼–æ’ã€‚
//
// ç›®æ ‡ï¼š
// - å®ç°å®Œæ•´çš„å°„æ‰‹ç”Ÿå‘½å‘¨æœŸï¼šå¤‡æˆ˜å° â†’ é˜Ÿåˆ— â†’ ä¼ é€å¸¦ â†’ è¿”å›/ç»åœ°åå‡»
// - é‡‡ç”¨é¢„è®¡ç®—ç®—æ³•ï¼ˆPreCalculatePathï¼‰æå‰è§„åˆ’å°„å‡»è·¯å¾„ï¼Œé¿å…å®æ—¶è®¡ç®—
// - æ”¯æŒç»åœ°åå‡»æ¨¡å¼ï¼ˆåœºä¸Šæœ€åä¸€ä¸ªå°„æ‰‹æ—¶2å€é€Ÿåº¦å†æ¬¡ä¸Šä¼ é€å¸¦ï¼‰
// - å¼¹è¯è€—å°½æ—¶æ’­æ”¾æ­»äº¡åŠ¨ç”»ï¼ˆæ—‹è½¬+ç¼©æ”¾ï¼‰åé”€æ¯
// - æä¾›å¹³æ»‘ç§»åŠ¨åŠ¨ç”»ï¼ˆåŸºäº AnimationCurve æ›²çº¿æ’å€¼ï¼‰
//
// éç›®æ ‡ï¼š
// - ä¸ç”Ÿæˆç½‘æ ¼æˆ–æ–¹å—ï¼ˆç”± GridManager è´Ÿè´£ï¼‰
// - ä¸ç®¡ç†é˜Ÿåˆ—å’Œå¤‡æˆ˜å°çŠ¶æ€ï¼ˆç”± ReadyQueueManager å’Œ ShooterTableManager è´Ÿè´£ï¼‰
// - ä¸å¤„ç†å­å¼¹é£è¡Œç»†èŠ‚ï¼ˆç”± BulletController è´Ÿè´£ï¼‰
// ================================================================================
using UnityEngine;
using UnityEngine.Events;
using System.Collections;
using System.Collections.Generic;
using TMPro;

// ========================================
// çŒªçŒªå°„æ‰‹çŠ¶æ€æšä¸¾
// ========================================
// InTable:       åœ¨å¤‡æˆ˜å°ä¸Šï¼ˆåˆå§‹çŠ¶æ€ï¼Œç­‰å¾…ç©å®¶ç‚¹å‡»é€‰ä¸­ï¼‰
// InQueue:       åœ¨å‡†å¤‡é˜Ÿåˆ—ä¸­ï¼ˆè¢«é€‰ä¸­åæ’é˜Ÿï¼Œç­‰å¾…ç©å®¶å†æ¬¡ç‚¹å‡»ä¸Šä¼ é€å¸¦ï¼‰
// OnBelt:        åœ¨ä¼ é€å¸¦ä¸Šå·¡é€»å°„å‡»ä¸­
// Returning:     å·¡é€»å®Œæ¯•ï¼Œæ­£åœ¨è¿”å›é˜Ÿåˆ—
// Transitioning: è¿‡æ¸¡çŠ¶æ€ï¼ˆä»ä¸€ä¸ªä½ç½®ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®çš„ä¸­é—´çŠ¶æ€ï¼‰
public enum PigState { InTable, InQueue, OnBelt, Returning, Transitioning }

// ========================================
// å°„å‡»æ’æœŸè¡¨ç»“æ„ä½“
// ========================================
// ç”¨äºé¢„è®¡ç®—ä¼ é€å¸¦è·¯å¾„ä¸Šçš„å°„å‡»è®¡åˆ’
// å­˜å‚¨"åœ¨ä¼ é€å¸¦ç¬¬å‡ æ­¥"åº”è¯¥å‘"å“ªä¸ªç›®æ ‡"å¼€ç«
struct ShotScheduleItem
{
    public int beltStepIndex;    // åœ¨ä¼ é€å¸¦èµ°çš„ç¬¬å‡ æ­¥å¼€ç«ï¼ˆ0-basedç´¢å¼•ï¼‰
    public CellController target; // ç›®æ ‡æ–¹å—æ§åˆ¶å™¨å¼•ç”¨
}

// ========================================
// çŒªçŒªå°„æ‰‹æ§åˆ¶å™¨ (PigController)
// ========================================
// è¿™æ˜¯æ¸¸æˆçš„æ ¸å¿ƒè§’è‰²æ§åˆ¶å™¨ï¼Œè´Ÿè´£ç®¡ç†å°„æ‰‹çŒªçŒªçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š
// 1. çŠ¶æ€ç®¡ç†ï¼šä»å¤‡æˆ˜å° -> é˜Ÿåˆ— -> ä¼ é€å¸¦ -> è¿”å›é˜Ÿåˆ—
// 2. å°„å‡»é€»è¾‘ï¼šé¢„è®¡ç®—å°„å‡»è·¯å¾„ï¼Œåœ¨ä¼ é€å¸¦ä¸Šè‡ªåŠ¨ç„å‡†å¼€ç«
// 3. ç§»åŠ¨ç³»ç»Ÿï¼šå¹³æ»‘ç§»åŠ¨åŠ¨ç”»ï¼Œæ”¯æŒæ›²çº¿æ’å€¼
// 4. ç»åœ°åå‡»ï¼šå½“åœºä¸Šæ— å…¶ä»–å°„æ‰‹æ—¶ï¼Œè‡ªåŠ¨åŠ é€ŸäºŒæ¬¡ä¸Šä¼ é€å¸¦
// 5. æ­»äº¡åŠ¨ç”»ï¼šå¼¹è¯è€—å°½æ—¶æ’­æ”¾æ—‹è½¬ç¼©æ”¾åŠ¨ç”»åé”€æ¯
// ========================================
public class PigController : MonoBehaviour
{
    // ========================================
    // åŸºç¡€å±æ€§é…ç½®
    // ========================================
    [Header("=== åŸºç¡€å±æ€§ ===")]
    public string colorID = "red";          // å°„æ‰‹çš„é¢œè‰²æ ‡è¯†ï¼Œåªèƒ½æ‰“ç›¸åŒé¢œè‰²çš„æ–¹å—
    public int ammo = 20;                   // å½“å‰å¼¹è¯æ•°ï¼ˆæ¯å‘å°„ä¸€æ¬¡å‡1ï¼Œå½’é›¶æ—¶è§¦å‘æ­»äº¡ï¼‰
    public GameObject bulletPrefab;         // å­å¼¹é¢„åˆ¶ä½“å¼•ç”¨

    // ========================================
    // UI ä¸ è§†è§‰ç»„ä»¶
    // ========================================
    [Header("=== UI ä¸ è§†è§‰å¼•ç”¨ ===")]
    public TextMeshPro ammoTextUI;          // ç”¨äºæ˜¾ç¤ºå‰©ä½™å¼¹è¯æ•°çš„æ–‡æœ¬ç»„ä»¶
    public Renderer bodyRenderer;           // å°„æ‰‹èº«ä½“çš„æ¸²æŸ“å™¨ï¼ˆç”¨äºè®¾ç½®æè´¨é¢œè‰²ï¼‰

    // ========================================
    // ç§»åŠ¨æ‰‹æ„Ÿå‚æ•°è°ƒèŠ‚
    // ========================================
    [Header("=== æ‰‹æ„Ÿè°ƒèŠ‚ ===")]
    public AnimationCurve moveCurve = AnimationCurve.EaseInOut(0, 0, 1, 1);  // ç§»åŠ¨æ›²çº¿ï¼ˆç¼“å…¥ç¼“å‡ºæ•ˆæœï¼‰
    public float moveDuration = 0.4f;       // å•æ¬¡ç§»åŠ¨çš„æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰

    // ========================================
    // å†…éƒ¨è¿è¡Œæ—¶çŠ¶æ€
    // ========================================
    [Header("=== å†…éƒ¨çŠ¶æ€ ===")]
    public PigState currentState = PigState.InTable;  // å½“å‰çŠ¶æ€ï¼ˆé»˜è®¤åœ¨å¤‡æˆ˜å°ï¼‰
    private int currentQueueIndex = -1;               // å½“å‰åœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ç´¢å¼•ï¼ˆ-1è¡¨ç¤ºä¸åœ¨é˜Ÿåˆ—ï¼‰
    
    // ========================================
    // ç»åœ°åå‡»åŠ é€Ÿæœºåˆ¶
    // ========================================
    // å½“åœºä¸Šæ²¡æœ‰å…¶ä»–å°„æ‰‹ï¼ˆå¤‡æˆ˜å°å’Œé˜Ÿåˆ—éƒ½ä¸ºç©ºï¼‰æ—¶è§¦å‘
    // æ­¤æ—¶å°„æ‰‹ä¼šä»¥2å€é€Ÿåº¦å†æ¬¡å†²ä¸Šä¼ é€å¸¦è¿›è¡Œæœ€åä¸€æ
    private bool isBoosted = false;                   // æ˜¯å¦å¤„äºåŠ é€Ÿï¼ˆç»åœ°åå‡»ï¼‰çŠ¶æ€

    // ========================================
    // å†…éƒ¨ç»„ä»¶å¼•ç”¨
    // ========================================
    private BeltWalker beltWalker;                    // ä¼ é€å¸¦è¡Œèµ°ç»„ä»¶ï¼ˆæ§åˆ¶åœ¨ä¼ é€å¸¦ä¸Šçš„ç§»åŠ¨é€Ÿåº¦ï¼‰
    
    // ========================================
    // å°„å‡»æ’æœŸè¡¨ï¼ˆé¢„è®¡ç®—ç³»ç»Ÿï¼‰
    // ========================================
    // åœ¨ä¸Šä¼ é€å¸¦å‰ï¼Œä¼šé¢„å…ˆè®¡ç®—æ•´ä¸ªä¼ é€å¸¦è·¯å¾„ä¸Šæ‰€æœ‰å¯ä»¥å‘½ä¸­çš„ç›®æ ‡
    // å°†æ¯ä¸ªå°„å‡»ç‚¹è®°å½•ä¸º (æ­¥æ•°ç´¢å¼•, ç›®æ ‡æ–¹å—) çš„é…å¯¹ï¼Œå­˜å…¥é˜Ÿåˆ—
    // åœ¨ä¼ é€å¸¦ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§æ’æœŸè¡¨ä¾æ¬¡å¼€ç«
    private Queue<ShotScheduleItem> shotSchedule = new Queue<ShotScheduleItem>();

    // ========================================
    // Unity ç”Ÿå‘½å‘¨æœŸï¼šAwake
    // ========================================
    // åœ¨è„šæœ¬å®ä¾‹è¢«åŠ è½½æ—¶è°ƒç”¨ï¼ˆæ¯” Start æ›´æ—©ï¼‰
    // ç”¨äºè·å–ç»„ä»¶å¼•ç”¨
    void Awake()
    {
        beltWalker = GetComponent<BeltWalker>();  // è·å–åŒGameObjectä¸Šçš„BeltWalkerç»„ä»¶
    }

    // ========================================
    // åˆå§‹åŒ–æ•°æ®ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰
    // ========================================
    // åœ¨å®ä¾‹åŒ–å°„æ‰‹åï¼Œç”±å¤–éƒ¨ç®¡ç†å™¨è°ƒç”¨æ­¤æ–¹æ³•è®¾ç½®åˆå§‹å‚æ•°
    // å‚æ•°ï¼š
    //   color - é¢œè‰²æ ‡è¯†ï¼ˆå¦‚ "red", "blue" ç­‰ï¼‰
    //   bulletCount - åˆå§‹å¼¹è¯æ•°
    public void InitData(string color, int bulletCount)
    {
        this.colorID = color;
        this.ammo = bulletCount;
        
        // æ ¹æ®é¢œè‰²IDè®¾ç½®èº«ä½“æè´¨
        if (GridManager.Instance != null && bodyRenderer != null)
        {
            Material mat = GridManager.Instance.GetMaterialByColorID(this.colorID);
            if (mat != null) bodyRenderer.material = mat;
        }
        
        UpdateAmmoUI();  // æ›´æ–°UIæ˜¾ç¤º
    }
    
    // ========================================
    // çŠ¶æ€è®¾ç½®å™¨ï¼ˆç®€å•å°è£…ï¼‰
    // ========================================
    public void SetState(PigState state) { currentState = state; }

    // ========================================
    // Unity ç”Ÿå‘½å‘¨æœŸï¼šUpdate
    // ========================================
    // æ³¨æ„ï¼šUpdate æ–¹æ³•æœ¬ä½“ç•™ç©ºï¼Œæ˜¯å› ä¸ºæ‰€æœ‰ä¸»é€»è¾‘ï¼ˆå¦‚ç§»åŠ¨ã€å°„å‡»ç­‰ï¼‰éƒ½å·²è¢«å®ç°ä¸ºåç¨‹ï¼ˆCoroutineï¼‰ã€‚
    // è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æ›´å®¹æ˜“åœ°æ§åˆ¶æ—¶åºå’ŒåŠ¨ç”»ï¼Œæ¯”å¦‚ç­‰å¾…åŠ¨ç”»æ’­æ”¾å®Œåå†å¤„ç†ä¸‹ä¸€æ­¥ï¼Œæˆ–è€…åˆ†æ­¥æ‰§è¡Œå¤æ‚æµç¨‹ã€‚
    // å¦‚æœä»¥åéœ€è¦å“åº”å®æ—¶è¾“å…¥æˆ–å®ç°å®šæ—¶å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨æ­¤åŠ å…¥ä»£ç ã€‚
    // å½“å‰æ— éœ€æ¯å¸§ä¸»åŠ¨å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ç©ºçš„ã€‚
    void Update()
    {
    }

    // ========================================
    // UI æ›´æ–°ï¼šå¼¹è¯æ˜¾ç¤º
    // ========================================
    void UpdateAmmoUI()
    {
        if (ammoTextUI != null) ammoTextUI.text = ammo.ToString();
    }

    // ========================================
    // ç©å®¶äº¤äº’ï¼šé¼ æ ‡ç‚¹å‡»äº‹ä»¶
    // ========================================
    // Unity çš„å†…ç½®äº‹ä»¶ï¼Œå½“ç©å®¶ç‚¹å‡»æ­¤å¯¹è±¡æ—¶è§¦å‘
    // æ ¹æ®å½“å‰çŠ¶æ€æ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼š
    //   - InTable çŠ¶æ€ï¼šé€šçŸ¥ ShooterTableManager å¤„ç†é€‰ä¸­é€»è¾‘ï¼ˆé€šå¸¸æ˜¯ç§»åˆ°é˜Ÿåˆ—ï¼‰
    //   - InQueue çŠ¶æ€ï¼šç›´æ¥è°ƒç”¨ GoToBelt() ä¸Šä¼ é€å¸¦
    void OnMouseDown()
    {
        if (currentState == PigState.InTable)
        {
            // åœ¨å¤‡æˆ˜å°ä¸Šè¢«ç‚¹å‡»ï¼Œé€šçŸ¥ç®¡ç†å™¨
            if (ShooterTableManager.Instance != null) 
                ShooterTableManager.Instance.OnPigClicked(this);
        }
        else if (currentState == PigState.InQueue)
        {
            // åœ¨é˜Ÿåˆ—ä¸­è¢«ç‚¹å‡»ï¼Œç›´æ¥ä¸Šä¼ é€å¸¦
            GoToBelt();
        }
    }

    // ========================================
    // åŠ¨ä½œï¼šç§»åŠ¨åˆ°é˜Ÿåˆ—
    // ========================================
    // ç”±å¤–éƒ¨ç®¡ç†å™¨è°ƒç”¨ï¼Œå°†å°„æ‰‹ä»å¤‡æˆ˜å°ç§»åŠ¨åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä½ç½®
    // å‚æ•°ï¼š
    //   slotIndex - é˜Ÿåˆ—æ§½ä½ç´¢å¼•
    //   pos - ç›®æ ‡ä½ç½®çš„ä¸–ç•Œåæ ‡
    public void MoveToQueue(int slotIndex, Vector3 pos)
    {
        currentState = PigState.InQueue;            // æ›´æ–°çŠ¶æ€
        currentQueueIndex = slotIndex;               // è®°å½•é˜Ÿåˆ—ä½ç½®
        
        // åœ¨é˜Ÿåˆ—ç®¡ç†å™¨ä¸­æ³¨å†Œè‡ªå·±
        if (ReadyQueueManager.Instance != null) 
            ReadyQueueManager.Instance.RegisterPig(slotIndex, this);
        
        SmoothMoveTo(pos);                          // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
    }

    // ========================================
    // åŠ¨ä½œï¼šä¸Šä¼ é€å¸¦ï¼ˆæ ¸å¿ƒæµç¨‹å…¥å£ï¼‰
    // ========================================
    // å°„æ‰‹ä»é˜Ÿåˆ—è¿›å…¥ä¼ é€å¸¦çš„å®Œæ•´æµç¨‹ï¼š
    // 1. ä»é˜Ÿåˆ—ä¸­æ³¨é”€
    // 2. é¢„è®¡ç®—æ•´æ¡ä¼ é€å¸¦è·¯å¾„ä¸Šçš„å°„å‡»è®¡åˆ’
    // 3. å¯åŠ¨ä¼ é€å¸¦å·¡é€»åç¨‹
    void GoToBelt()
    {
        if (beltWalker == null) return;
        
        currentState = PigState.Transitioning;      // è®¾ç½®ä¸ºè¿‡æ¸¡çŠ¶æ€
        
        // ä»é˜Ÿåˆ—ç®¡ç†å™¨ä¸­æ³¨é”€
        if (ReadyQueueManager.Instance != null) 
            ReadyQueueManager.Instance.UnregisterPig(this);

        // è·å–ä¼ é€å¸¦è·¯å¾„
        if (BeltPathHolder.Instance != null && BeltPathHolder.Instance.waypoints.Count > 0)
        {
            // æ­¥éª¤1ï¼šé¢„è®¡ç®—è·¯å¾„ï¼ˆæ ¸å¿ƒç®—æ³•ï¼Œæå‰è§„åˆ’æ‰€æœ‰å°„å‡»ç‚¹ï¼‰
            PreCalculatePath();
            
            // æ­¥éª¤2ï¼šå¼€å§‹ä¼ é€å¸¦å·¡é€»åºåˆ—ï¼ˆæ‰§è¡Œé¢„è®¡ç®—çš„è®¡åˆ’ï¼‰
            StartCoroutine(RunBeltSequence(BeltPathHolder.Instance.waypoints));
        }
        else
        {
            Debug.LogError("é”™è¯¯ï¼šåœºæ™¯é‡Œæ‰¾ä¸åˆ° BeltPathHolderï¼");
        }
    }

    // =========================================================
    // ã€æ ¸å¿ƒç®—æ³•ã€‘é¢„è®¡ç®—å°„å‡»è·¯å¾„
    // =========================================================
    // è¿™æ˜¯æ¸¸æˆæœ€æ ¸å¿ƒçš„ç®—æ³•ä¹‹ä¸€ï¼šåœ¨å°„æ‰‹ä¸Šä¼ é€å¸¦å‰ï¼Œæ¨¡æ‹Ÿæ•´ä¸ªä¼ é€å¸¦è·¯å¾„
    // è®¡ç®—å‡ºæ¯ä¸€æ­¥åº”è¯¥å‘å“ªä¸ªç›®æ ‡å¼€ç«ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„"å°„å‡»æ’æœŸè¡¨"
    //
    // å·¥ä½œåŸç†ï¼š
    // 1. æ¸…ç©ºæ—§çš„å°„å‡»æ’æœŸè¡¨
    // 2. æ¨¡æ‹Ÿå°„æ‰‹æ²¿ç€ä¼ é€å¸¦æ¯ä¸€æ­¥çš„ä½ç½®
    // 3. åœ¨æ¯ä¸ªä½ç½®æ£€æµ‹æ˜¯å¦æœ‰å¯å°„å‡»çš„ç›®æ ‡ï¼ˆé¢œè‰²åŒ¹é…ã€æœªè¢«æ‘§æ¯ï¼‰
    // 4. å¦‚æœæœ‰ç›®æ ‡ï¼Œè®°å½•åˆ°æ’æœŸè¡¨ä¸­ï¼Œå¹¶æ ‡è®°ç›®æ ‡ä¸º"å¾…æ­»äº¡"ï¼ˆå ä½ï¼Œé¿å…é‡å¤ç„å‡†ï¼‰
    // 5. æ¯æ¬¡å°„å‡»æ¶ˆè€—1å‘æ¨¡æ‹Ÿå¼¹è¯ï¼Œç›´åˆ°å¼¹è¯è€—å°½æˆ–è·¯å¾„èµ°å®Œ
    //
    // ä¼˜åŠ¿ï¼š
    // - é¿å…å®æ—¶è®¡ç®—å¼€é”€ï¼Œæé«˜æ€§èƒ½
    // - ä¿è¯å°„å‡»æ—¶æœºå‡†ç¡®ï¼ˆä¸ä¼šå› ä¸ºå¸§ç‡æ³¢åŠ¨æ¼å°„ï¼‰
    // - æ–¹ä¾¿è°ƒè¯•å’Œå¯è§†åŒ–å°„å‡»è®¡åˆ’
    // =========================================================
    void PreCalculatePath()
    {
        if (GridManager.Instance == null) return;

        shotSchedule.Clear();                       // æ¸…ç©ºæ—§çš„æ’æœŸè¡¨
        int simulatedAmmo = ammo;                   // æ¨¡æ‹Ÿå¼¹è¯ï¼ˆä¸å½±å“çœŸå®å¼¹è¯ï¼‰
        int gridSize = GridManager.Instance.gridSize; // è·å–ç½‘æ ¼å¤§å°
        int totalSteps = gridSize * 4;              // æ€»æ­¥æ•° = 4æ¡è¾¹ Ã— æ¯è¾¹çš„æ ¼å­æ•°

        // éå†ä¼ é€å¸¦ä¸Šçš„æ¯ä¸€æ­¥
        for (int i = 0; i < totalSteps; i++)
        {
            if (simulatedAmmo <= 0) break;          // æ¨¡æ‹Ÿå¼¹è¯è€—å°½ï¼Œåœæ­¢è®¡ç®—

            // è·å–ç¬¬iæ­¥çš„æ¨¡æ‹Ÿä½ç½®
            Vector3 simPos = GridManager.Instance.GetSimulatedPosition(i);
            
            // æ™ºèƒ½æ£€æµ‹è¯¥ä½ç½®èƒ½å‘½ä¸­çš„æœ€ä½³ç›®æ ‡
            CellController target = GridManager.Instance.GetTargetCellSmart(simPos);

            // æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ•ˆä¸”åŒ¹é…æ¡ä»¶
            if (target != null 
                && !target.isDestroyed                // ç›®æ ‡æœªè¢«æ‘§æ¯
                && !target.isPendingDeath             // ç›®æ ‡æœªè¢«å…¶ä»–å°„å‡»è®¡åˆ’å ä½
                && target.colorID == this.colorID)    // é¢œè‰²åŒ¹é…
            {
                // åˆ›å»ºå°„å‡»æ’æœŸé¡¹
                ShotScheduleItem item = new ShotScheduleItem();
                item.beltStepIndex = i;               // è®°å½•åœ¨ç¬¬å‡ æ­¥å¼€ç«
                item.target = target;                 // è®°å½•ç›®æ ‡å¼•ç”¨
                shotSchedule.Enqueue(item);           // åŠ å…¥æ’æœŸè¡¨

                target.isPendingDeath = true;         // æ ‡è®°ç›®æ ‡ä¸º"å¾…æ­»äº¡"ï¼ˆå ä½ï¼‰
                simulatedAmmo--;                      // æ¶ˆè€—æ¨¡æ‹Ÿå¼¹è¯
            }
        }
    }

    // =========================================================
    // ã€æ ¸å¿ƒåç¨‹ã€‘æ‰§è¡Œä¼ é€å¸¦å·¡é€»ä¸å°„å‡»åºåˆ—
    // =========================================================
    // è¿™æ˜¯æ¸¸æˆçš„ä¸»è¦ç©æ³•å¾ªç¯ï¼Œå°„æ‰‹ä¼šï¼š
    // 1. é£å‘ä¼ é€å¸¦èµ·ç‚¹
    // 2. æ²¿ç€ä¼ é€å¸¦çš„4æ¡è¾¹ä¾æ¬¡å·¡é€»
    // 3. æŒ‰ç…§é¢„è®¡ç®—çš„æ’æœŸè¡¨ï¼Œåœ¨ç‰¹å®šä½ç½®è‡ªåŠ¨å¼€ç«
    // 4. å®æ—¶æ£€æµ‹å¼¹è¯ï¼Œå½’é›¶æ—¶è§¦å‘æ­»äº¡åŠ¨ç”»
    // 5. å·¡é€»å®Œæˆåå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆè¿”å›é˜Ÿåˆ— or ç»åœ°åå‡»ï¼‰
    //
    // å‚æ•°ï¼š
    //   path - ä¼ é€å¸¦è·¯å¾„çš„è·¯ç‚¹åˆ—è¡¨ï¼ˆé€šå¸¸æ˜¯4ä¸ªè§’ç‚¹ï¼‰
    //
    // æ”¯æŒåŠ é€Ÿï¼š
    //   å½“ isBoosted = true æ—¶ï¼Œç§»åŠ¨é€Ÿåº¦ç¿»å€ï¼ˆç»åœ°åå‡»æ¨¡å¼ï¼‰
    // =========================================================
    IEnumerator RunBeltSequence(List<Transform> path)
    {
        // ========================================
        // é˜¶æ®µ1ï¼šé£å‘èµ·ç‚¹
        // ========================================
        currentState = PigState.Transitioning;
        yield return StartCoroutine(MoveRoutine(path[0].position));

        // ========================================
        // é˜¶æ®µ2ï¼šè½åœ°ï¼Œå¼€å§‹ä¼ é€å¸¦å·¡é€»
        // ========================================
        currentState = PigState.OnBelt;
        
        int gridSize = GridManager.Instance.gridSize;

        // ========================================
        // é€Ÿåº¦æ§åˆ¶ï¼ˆæ”¯æŒ Boost åŠ é€Ÿï¼‰
        // ========================================
        float baseSpeed = (beltWalker != null && beltWalker.speed > 0) ? beltWalker.speed : 5f;
        float currentRunSpeed = isBoosted ? (baseSpeed * 2f) : baseSpeed;  // ç»åœ°åå‡»æ—¶2å€é€Ÿ
        // ========================================

        // å°† Transform è·¯ç‚¹è½¬æ¢ä¸º Vector3 åˆ—è¡¨ï¼ˆæ–¹ä¾¿ç´¢å¼•ï¼‰
        List<Vector3> waypoints = new List<Vector3>();
        foreach(var t in path) waypoints.Add(t.position);
        
        // ========================================
        // é˜¶æ®µ3ï¼šå·¡é€»4æ¡è¾¹
        // ========================================
        // ä¼ é€å¸¦æ˜¯æ–¹å½¢è·¯å¾„ï¼Œæœ‰4ä¸ªè§’ç‚¹ï¼Œå°„æ‰‹ä¼šæ²¿ç€è¿™4æ¡è¾¹ç§»åŠ¨
        for (int segmentIndex = 0; segmentIndex < 4; segmentIndex++)
        {
            // å½“å‰è¾¹çš„èµ·ç‚¹å’Œç»ˆç‚¹
            Vector3 start = waypoints[segmentIndex];
            Vector3 end = waypoints[(segmentIndex + 1) % waypoints.Count];
            
            // è®¡ç®—å½“å‰è¾¹å¯¹åº”çš„æ­¥æ•°èŒƒå›´
            // ä¾‹å¦‚ï¼šè¾¹0å¯¹åº”æ­¥æ•° 0~(gridSize-1)ï¼Œè¾¹1å¯¹åº”æ­¥æ•° gridSize~(2*gridSize-1)
            int minStepIndex = segmentIndex * gridSize;
            int maxStepIndex = (segmentIndex + 1) * gridSize - 1;

            // è®¡ç®—ç§»åŠ¨æ—¶é—´
            float segmentDist = Vector3.Distance(start, end);
            float travelTime = segmentDist / currentRunSpeed;  // åº”ç”¨åŠ é€Ÿåçš„é€Ÿåº¦
            float timer = 0f;

            // åœ¨è¿™æ¡è¾¹ä¸Šç§»åŠ¨
            while (timer < travelTime)
            {
                timer += Time.deltaTime;
                float fraction = timer / travelTime;               // ç§»åŠ¨è¿›åº¦ 0~1
                transform.position = Vector3.Lerp(start, end, fraction);  // çº¿æ€§æ’å€¼ç§»åŠ¨
                
                // è®¡ç®—å½“å‰æ‰€åœ¨çš„æ­¥æ•°ç´¢å¼•
                int currentStep = minStepIndex + Mathf.FloorToInt(fraction * gridSize);

                // ========================================
                // æ£€æŸ¥å°„å‡»æ’æœŸè¡¨
                // ========================================
                // å¦‚æœæ’æœŸè¡¨ä¸­ä¸‹ä¸€ä¸ªå°„å‡»ç‚¹çš„æ­¥æ•° <= å½“å‰æ­¥æ•°ï¼Œåˆ™å¼€ç«
                if (shotSchedule.Count > 0)
                {
                    ShotScheduleItem nextShot = shotSchedule.Peek();
                    
                    // å¦‚æœä¸‹ä¸€ä¸ªå°„å‡»ç‚¹åœ¨åé¢çš„è¾¹ä¸Šï¼Œè·³è¿‡
                    if (nextShot.beltStepIndex > maxStepIndex) 
                    { 
                        // ä»€ä¹ˆä¹Ÿä¸åšï¼Œç»§ç»­ç§»åŠ¨
                    }
                    // å¦‚æœå½“å‰æ­¥æ•°å·²åˆ°è¾¾æˆ–è¶…è¿‡å°„å‡»ç‚¹ï¼Œæ‰§è¡Œå°„å‡»
                    else if (currentStep >= nextShot.beltStepIndex)
                    {
                        PerformVisualFire(nextShot.target);  // å¼€ç«ï¼
                        shotSchedule.Dequeue();              // ä»æ’æœŸè¡¨ä¸­ç§»é™¤
                    }
                }

                // ========================================
                // ã€å…³é”®æ£€æµ‹ã€‘å¼¹è¯è€—å°½å¤„ç†
                // ========================================
                // å¦‚æœå¼¹è¯å½’é›¶ï¼Œç«‹å³åœæ­¢ç§»åŠ¨å¹¶æ’­æ”¾æ­»äº¡åŠ¨ç”»
                if (ammo <= 0)
                {
                    Debug.Log("å¼¹è¯è€—å°½ï¼Œæ’­æ”¾æ­»äº¡åŠ¨ç”»...");

                    // 1. ç«‹å³åœæ­¢ç§»åŠ¨ï¼ˆä¸å†ç»§ç»­ yield return null å¾ªç¯ï¼‰
                    
                    // 2. æ’­æ”¾æ­»äº¡åŠ¨ç”»ï¼Œå¹¶ç­‰å¾…å®ƒæ’­å®Œ
                    yield return StartCoroutine(PerformDeathAnimation());

                    // 3. å½»åº•é”€æ¯æ¸¸æˆå¯¹è±¡
                    Destroy(gameObject);
                    
                    // 4. é€€å‡ºæ•´ä¸ª RunBeltSequence åç¨‹
                    yield break; 
                }
                
                yield return null;  // ç­‰å¾…ä¸‹ä¸€å¸§
            }
            
            // ç¡®ä¿ç²¾ç¡®åˆ°è¾¾ç»ˆç‚¹ï¼ˆé¿å…æµ®ç‚¹è¯¯å·®ï¼‰
            transform.position = end;
        }

        // ========================================
        // é˜¶æ®µ4ï¼šå·¡é€»å®Œæˆï¼Œå†³å®šä¸‹ä¸€æ­¥
        // ========================================
        CheckEndGameAndReturn();
    }

    // ========================================
    // æ‰§è¡Œè§†è§‰å°„å‡»æ•ˆæœ
    // ========================================
    // å½“å°„æ‰‹åˆ°è¾¾å°„å‡»ç‚¹æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ‰§è¡Œå®é™…çš„å°„å‡»åŠ¨ä½œ
    // åŒ…æ‹¬ï¼š
    // 1. æ¶ˆè€—1å‘å¼¹è¯
    // 2. æ›´æ–°UIæ˜¾ç¤º
    // 3. ç”Ÿæˆå­å¼¹å¯¹è±¡å¹¶å‘å°„å‘ç›®æ ‡
    //
    // å‚æ•°ï¼š
    //   target - è¦å°„å‡»çš„ç›®æ ‡æ–¹å—
    void PerformVisualFire(CellController target)
    {
        ammo--;                     // æ¶ˆè€—å¼¹è¯
        UpdateAmmoUI();             // æ›´æ–°UIæ˜¾ç¤º

        // ç”Ÿæˆå­å¼¹å¹¶å‘å°„
        if (bulletPrefab != null) 
        {
            GameObject b = Instantiate(bulletPrefab);
            b.GetComponent<BulletController>().Fire(target, transform.position);
        }
    }

    // ========================================
    // å·¡é€»ç»“æŸå†³ç­–ï¼šè¿”å›é˜Ÿåˆ— or ç»åœ°åå‡»
    // ========================================
    // å°„æ‰‹å®Œæˆä¸€åœˆä¼ é€å¸¦å·¡é€»åï¼Œä¼šæ£€æŸ¥åœºä¸ŠçŠ¶æ€å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š
    //
    // ã€ç»åœ°åå‡»æ¨¡å¼ã€‘æ¡ä»¶ï¼š
    //   - å¤‡æˆ˜å°å®Œå…¨ç©ºäº†ï¼ˆæ²¡æœ‰æ–°å°„æ‰‹å¯ä»¥é€‰ï¼‰
    //   - é˜Ÿåˆ—ä¹Ÿå®Œå…¨ç©ºäº†ï¼ˆæ²¡æœ‰å…¶ä»–å°„æ‰‹åœ¨æ’é˜Ÿï¼‰
    //   => è¯´æ˜è¿™æ˜¯åœºä¸Šæœ€åä¸€ä¸ªå°„æ‰‹ï¼Œè§¦å‘"ç»åœ°åå‡»"
    //   => ä»¥2å€é€Ÿåº¦ç›´æ¥å†ä¸Šä¸€æ¬¡ä¼ é€å¸¦ï¼Œæœ€åä¸€æï¼
    //
    // ã€æ­£å¸¸è¿”å›æ¨¡å¼ã€‘æ¡ä»¶ï¼š
    //   - å¤‡æˆ˜å°æˆ–é˜Ÿåˆ—ä¸­è¿˜æœ‰å…¶ä»–å°„æ‰‹
    //   => æ­£å¸¸è¿”å›é˜Ÿåˆ—ï¼Œæ’é˜Ÿç­‰å¾…ä¸‹æ¬¡å‡ºå‡»
    // ========================================
    void CheckEndGameAndReturn()
    {
        bool isTableEmpty = false;
        bool isQueueEmpty = false;
        
        // æ£€æŸ¥å¤‡æˆ˜å°æ˜¯å¦ä¸ºç©º
        if (ShooterTableManager.Instance != null) 
            isTableEmpty = ShooterTableManager.Instance.IsTableEmpty();
        
        // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
        if (ReadyQueueManager.Instance != null) 
            isQueueEmpty = ReadyQueueManager.Instance.IsQueueEmpty();

        // ç»åœ°åå‡»æ¡ä»¶ï¼šä¸¤å¤„å…¨ç©º
        if (isTableEmpty && isQueueEmpty)
        {
            StartCoroutine(AutoRejoinBelt());  // è§¦å‘ç»åœ°åå‡»
        }
        else
        {
            ReturnToQueueNormal();             // æ­£å¸¸è¿”å›é˜Ÿåˆ—
        }
    }

    // ========================================
    // ã€ç»åœ°åå‡»æ¨¡å¼ã€‘è‡ªåŠ¨å†æ¬¡ä¸Šä¼ é€å¸¦
    // ========================================
    // è¿™æ˜¯æ¸¸æˆçš„é«˜æ½®æ—¶åˆ»ï¼å½“åœºä¸Šåªå‰©è¿™ä¸€ä¸ªå°„æ‰‹æ—¶ï¼Œå®ƒä¸ä¼šè¿”å›é˜Ÿåˆ—ï¼Œ
    // è€Œæ˜¯ç«‹å³åŠ é€Ÿå†²å›ä¼ é€å¸¦ï¼Œä»¥2å€é€Ÿåº¦å†æ‰“ä¸€åœˆï¼
    //
    // æµç¨‹ï¼š
    // 1. å…ˆ"å›å¼¹"åˆ°é˜Ÿåˆ—ä½ç½®ï¼ˆè§†è§‰æ•ˆæœï¼ŒåŠ å¿«èŠ‚å¥ï¼‰
    // 2. å¼€å¯åŠ é€ŸçŠ¶æ€ï¼ˆisBoosted = trueï¼Œç§»åŠ¨é€Ÿåº¦Ã—2ï¼‰
    // 3. é‡æ–°é¢„è®¡ç®—å°„å‡»è·¯å¾„ï¼ˆå› ä¸ºä¸Šä¸€åœˆå¯èƒ½æ‰“æ‰äº†ä¸€äº›æ–¹å—ï¼Œæ ¼å±€å˜äº†ï¼‰
    // 4. å†æ¬¡å¯åŠ¨ä¼ é€å¸¦å·¡é€»åºåˆ—
    //
    // æ³¨æ„ï¼šæ­¤åç¨‹é€’å½’è°ƒç”¨ RunBeltSequenceï¼Œç†è®ºä¸Šå¯ä»¥æ— é™å¾ªç¯
    //       ç›´åˆ°å¼¹è¯è€—å°½æˆ–æ¸¸æˆç»“æŸæ¡ä»¶æ»¡è¶³
    // ========================================
    IEnumerator AutoRejoinBelt()
    {
        currentState = PigState.Returning;
        
        // æ‰¾ä¸€ä¸ªé˜Ÿåˆ—ä½ç½®ä½œä¸º"å›å¼¹"ç›®æ ‡ï¼ˆçº¯è§†è§‰æ•ˆæœï¼‰
        Vector3 bounceTarget = Vector3.zero;
        if (ReadyQueueManager.Instance != null)
        {
            int slotIndex = ReadyQueueManager.Instance.GetFirstEmptyIndex();
            if (slotIndex == -1) slotIndex = 0;  // å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå°±ç”¨0å·ä½ç½®
            bounceTarget = ReadyQueueManager.Instance.GetSlotPosition(slotIndex);
        }

        // è§†è§‰å›å¼¹æ•ˆæœï¼ˆåŠ å¿«ç§»åŠ¨é€Ÿåº¦ï¼Œè¥é€ ç´§å¼ æ„Ÿï¼‰
        float originalDuration = moveDuration;
        moveDuration = originalDuration * 0.5f;      // ç§»åŠ¨æ—¶é—´å‡åŠ
        yield return StartCoroutine(MoveRoutine(bounceTarget));

        // ========================================
        // å¼€å¯åŠ é€ŸçŠ¶æ€
        // ========================================
        isBoosted = true; 
        Debug.Log(">>> å¼€å¯ 2 å€é€Ÿç‹‚æš´æ¨¡å¼ï¼");
        // ========================================

        moveDuration = originalDuration;             // æ¢å¤åŸå§‹ç§»åŠ¨æ—¶é—´
        
        // ========================================
        // é‡æ–°é¢„è®¡ç®—è·¯å¾„ï¼ˆå…³é”®ï¼ï¼‰
        // ========================================
        // å› ä¸ºä¸Šä¸€åœˆå¯èƒ½æ‰“æ‰äº†ä¸€äº›æ–¹å—ï¼Œæ ¼å±€å˜äº†ï¼Œå¿…é¡»é‡ç®—
        PreCalculatePath(); 
        // ========================================

        // å†æ¬¡ä¸Šä¼ é€å¸¦ï¼ˆé€’å½’è°ƒç”¨ï¼‰
        if (BeltPathHolder.Instance != null)
        {
            // æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨çš„æ˜¯ RunBeltSequence (é¢„è®¡ç®—ç‰ˆ)
            yield return StartCoroutine(RunBeltSequence(BeltPathHolder.Instance.waypoints));
        }
    }

    // ========================================
    // ã€æ­£å¸¸è¿”å›æ¨¡å¼ã€‘è¿”å›é˜Ÿåˆ—
    // ========================================
    // å°„æ‰‹å®Œæˆä¼ é€å¸¦å·¡é€»åçš„æ­£å¸¸æµç¨‹ï¼š
    // 1. æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼ˆå¤±è´¥æ¡ä»¶ï¼‰
    // 2. å…³é—­åŠ é€ŸçŠ¶æ€
    // 3. æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç©ºä½
    // 4. åœ¨é˜Ÿåˆ—ç®¡ç†å™¨ä¸­æ³¨å†Œè‡ªå·±
    // 5. å¹³æ»‘ç§»åŠ¨åˆ°é˜Ÿåˆ—ä½ç½®
    //
    // å¤±è´¥æ¡ä»¶ï¼š
    //   å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼ˆæ‰€æœ‰æ§½ä½éƒ½è¢«å ç”¨ï¼‰ï¼Œè¯´æ˜å°„æ‰‹æ— å¤„å¯å»
    //   => æ¸¸æˆå¤±è´¥ï¼è§¦å‘ GameOver
    // ========================================
    void ReturnToQueueNormal()
    {
        if (ReadyQueueManager.Instance == null) return;

        // ========================================
        // æ£€æŸ¥å¤±è´¥æ¡ä»¶ï¼šé˜Ÿåˆ—å·²æ»¡
        // ========================================
        if (ReadyQueueManager.Instance.IsFull())
        {
            Debug.LogError("ğŸ’€ GAME OVER: é˜Ÿåˆ—å·²æ»¡ï¼");
            if (GameManager.Instance != null) 
                GameManager.Instance.GameOver(false);  // false = ç©å®¶å¤±è´¥
            Destroy(gameObject);
            return;
        }

        // ========================================
        // å…³é—­åŠ é€ŸçŠ¶æ€ï¼ˆå¦‚æœä¹‹å‰å¼€å¯è¿‡ï¼‰
        // ========================================
        isBoosted = false;
        // ========================================

        // æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç©ºä½
        int targetSlot = ReadyQueueManager.Instance.GetFirstEmptyIndex();
        Vector3 pos = ReadyQueueManager.Instance.GetSlotPosition(targetSlot);
        
        // æ›´æ–°çŠ¶æ€å’Œä½ç½®
        currentState = PigState.InQueue;
        currentQueueIndex = targetSlot;
        
        // åœ¨é˜Ÿåˆ—ç®¡ç†å™¨ä¸­æ³¨å†Œ
        ReadyQueueManager.Instance.RegisterPig(targetSlot, this);
        
        // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
        SmoothMoveTo(pos);
        
        // é‡ç½®æ—‹è½¬ï¼ˆç¡®ä¿ç«™ç«‹å§¿æ€æ­£ç¡®ï¼‰
        transform.rotation = Quaternion.identity;
    }

    // ========================================
    // å¹³æ»‘ç§»åŠ¨ï¼ˆå…¬å…±æ¥å£ï¼‰
    // ========================================
    // åœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ç§»åŠ¨ï¼Œå¯åŠ¨æ–°çš„ç§»åŠ¨åç¨‹
    // ç”¨äºä»»ä½•éœ€è¦ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®çš„åœºæ™¯
    //
    // å‚æ•°ï¼š
    //   targetPos - ç›®æ ‡ä½ç½®çš„ä¸–ç•Œåæ ‡
    public void SmoothMoveTo(Vector3 targetPos)
    {
        StopAllCoroutines();                    // åœæ­¢æ‰€æœ‰åç¨‹ï¼ˆé¿å…å†²çªï¼‰
        StartCoroutine(MoveRoutine(targetPos)); // å¯åŠ¨æ–°çš„ç§»åŠ¨åç¨‹
    }

    // ========================================
    // ç§»åŠ¨åç¨‹ï¼ˆæ ¸å¿ƒç§»åŠ¨ç®—æ³•ï¼‰
    // ========================================
    // ä½¿ç”¨åŠ¨ç”»æ›²çº¿å®ç°å¹³æ»‘çš„ç¼“å…¥ç¼“å‡ºæ•ˆæœ
    // æ¯”ç®€å•çš„ Lerp æ›´æœ‰æ‰‹æ„Ÿï¼Œæ›´ç¬¦åˆçœŸå®ç‰©ç†è¿åŠ¨
    //
    // å‚æ•°ï¼š
    //   target - ç›®æ ‡ä½ç½®
    //
    // å·¥ä½œåŸç†ï¼š
    // 1. è®°å½•èµ·å§‹ä½ç½®
    // 2. åœ¨ moveDuration æ—¶é—´å†…ï¼Œæ¯å¸§æ›´æ–°ä½ç½®
    // 3. ä½¿ç”¨ moveCurve æ›²çº¿è®¡ç®—æ’å€¼ç™¾åˆ†æ¯”ï¼ˆè€Œéçº¿æ€§ï¼‰
    // 4. ç”¨ LerpUnclamped å…è®¸æ›²çº¿è¶…å‡º [0,1] èŒƒå›´ï¼ˆæ”¯æŒå¼¹æ€§æ•ˆæœï¼‰
    // ========================================
    IEnumerator MoveRoutine(Vector3 target)
    {
        Vector3 startPos = transform.position;
        float timer = 0f;
        
        while (timer < moveDuration)
        {
            timer += Time.deltaTime;
            float percent = timer / moveDuration;  // 0 ~ 1 çš„è¿›åº¦
            
            // ä½¿ç”¨æ›²çº¿è®¡ç®—å®é™…æ’å€¼ç™¾åˆ†æ¯”ï¼ˆæ”¯æŒç¼“å…¥ç¼“å‡ºç­‰æ•ˆæœï¼‰
            transform.position = Vector3.LerpUnclamped(
                startPos, 
                target, 
                moveCurve.Evaluate(percent)
            );
            
            yield return null;  // ç­‰å¾…ä¸‹ä¸€å¸§
        }
        
        // ç¡®ä¿ç²¾ç¡®åˆ°è¾¾ç›®æ ‡ï¼ˆé¿å…æµ®ç‚¹è¯¯å·®ï¼‰
        transform.position = target;
    }

    // ==========================================
    // ã€æ­»äº¡åŠ¨ç”»ã€‘å¼¹è¯è€—å°½æ—¶çš„è§†è§‰æ•ˆæœ
    // ==========================================
    // å½“å°„æ‰‹å¼¹è¯å½’é›¶æ—¶ï¼Œä¼šæ’­æ”¾è¿™ä¸ª0.3ç§’çš„æ­»äº¡åŠ¨ç”»ï¼Œç„¶åé”€æ¯
    //
    // åŠ¨ç”»åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
    // ã€ç¬¬ä¸€é˜¶æ®µã€‘0 ~ 0.15ç§’ï¼š
    //   - æ—‹è½¬ï¼šé¡ºæ—¶é’ˆæ—‹è½¬ 360 åº¦ï¼ˆç»• Y è½´ï¼‰
    //   - ç¼©æ”¾ï¼šä»åŸå§‹å¤§å°æ”¾å¤§åˆ° 1.2 å€
    //
    // ã€ç¬¬äºŒé˜¶æ®µã€‘0.15 ~ 0.3ç§’ï¼š
    //   - æ—‹è½¬ï¼šé€†æ—¶é’ˆæ—‹è½¬å›å»ï¼ˆ360åº¦ -> 0åº¦ï¼‰
    //   - ç¼©æ”¾ï¼šä» 1.2 å€ç¼©å°åˆ° 0ï¼ˆå®Œå…¨æ¶ˆå¤±ï¼‰
    //
    // è§†è§‰æ•ˆæœï¼š
    //   åƒä¸€ä¸ªæ°”çƒå…ˆè†¨èƒ€æ—‹è½¬ï¼Œç„¶åæ”¾æ°”ç¼©å°æ¶ˆå¤±
    //   è¥é€ å‡º"èƒ½é‡è€—å°½"çš„æ„Ÿè§‰
    // ==========================================
    IEnumerator PerformDeathAnimation()
    {
        float totalDuration = 0.3f;                  // æ€»åŠ¨ç”»æ—¶é•¿
        float halfDuration = totalDuration / 2f;     // å•é˜¶æ®µæ—¶é•¿
        
        Vector3 originalScale = transform.localScale; // è®°ä½åˆå§‹å¤§å°
        Quaternion originalRot = transform.rotation;  // è®°ä½åˆå§‹æœå‘

        // ========================================
        // ç¬¬ä¸€é˜¶æ®µï¼šè†¨èƒ€ + é¡ºæ—¶é’ˆæ—‹è½¬ (0 ~ 0.15ç§’)
        // ========================================
        float timer = 0f;
        while (timer < halfDuration)
        {
            timer += Time.deltaTime;
            float t = timer / halfDuration;  // 0 ~ 1 çš„è¿›åº¦

            // ç¼©æ”¾ï¼šä»åŸå§‹å¤§å°æ”¾å¤§åˆ° 1.2 å€
            transform.localScale = Vector3.Lerp(originalScale, originalScale * 1.2f, t);
            
            // æ—‹è½¬ï¼šé¡ºæ—¶é’ˆè½¬ 360 åº¦ï¼ˆç»• Y è½´ï¼‰
            // t = 0 æ—¶è§’åº¦ = 0ï¼Œt = 1 æ—¶è§’åº¦ = 360
            transform.rotation = originalRot * Quaternion.Euler(0, 360f * t, 0);

            yield return null;
        }

        // ========================================
        // ç¬¬äºŒé˜¶æ®µï¼šæ”¶ç¼© + é€†æ—¶é’ˆæ—‹è½¬ (0.15 ~ 0.3ç§’)
        // ========================================
        timer = 0f;
        Vector3 bigScale = originalScale * 1.2f;  // è®°ä½æ”¾å¤§åçš„å¤§å°
        
        while (timer < halfDuration)
        {
            timer += Time.deltaTime;
            float t = timer / halfDuration;  // 0 ~ 1 çš„è¿›åº¦

            // ç¼©æ”¾ï¼šä» 1.2 å€ç¼©å°åˆ° 0ï¼ˆå®Œå…¨æ¶ˆå¤±ï¼‰
            transform.localScale = Vector3.Lerp(bigScale, Vector3.zero, t);
            
            // æ—‹è½¬ï¼šé€†æ—¶é’ˆè½¬å›å»ï¼ˆ360åº¦ -> 0åº¦ï¼‰
            // t = 0 æ—¶è§’åº¦ = 360ï¼Œt = 1 æ—¶è§’åº¦ = 0
            float angle = Mathf.Lerp(360f, 0f, t);
            transform.rotation = originalRot * Quaternion.Euler(0, angle, 0);

            yield return null;
        }

        // ========================================
        // å½»åº•éšè—ï¼ˆé˜²æ­¢ Destroy å»¶è¿Ÿå¯¼è‡´çš„é—ªçƒï¼‰
        // ========================================
        transform.localScale = Vector3.zero;
    }


}